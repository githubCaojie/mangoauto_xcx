// pages/RemindingPrice/RemindingPrice.js
Page({

  /**
   * 页面的初始数据
   */
  data: {
    dataCarCode: '',
    dataCarName: '',
    carBrandList: [],
    dataSeriesCode: '',
    carSeriesInfo: [],
    carSeriesIndex: -1,
    carSerieCode: '',
    carTypesInfo: [],
    carTypesIndex: -1,
    cartypeCode: '',
    priceVal: '1000',
    userMobile: '',
  },
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    var that = this;
    var usermobile = wx.getStorageSync('userInfo').CellPhone;
    that.setData({
      userMobile: usermobile
    })
  },
  /**
   * 点击事件
   */
  resetCartype: function (e) {
    var that = this;
    that.setData({
      dataCarCode: '',
      dataCarName: '',
      carBrandList: [],
      dataSeriesCode: '',
      carSeriesInfo: [],
      carSeriesIndex: -1,
      carSerieCode: '',
      carTypesInfo: [],
      carTypesIndex: -1,
      cartypeCode: '',
      priceVal: '1000',
    })
  },
  getbrandInfo: function (e) {
    var that = this;
    wx.request({
      url: 'https://api.mangoauto.com.cn/Wx/GetPropInfo.ashx?property_id=1&brandname=' + e,
      data: {},
      header: {
        'Content-Type': 'application/json'
      },
      success: function (res) {
        that.setData({
          carBrandList: res.data.data,
          carSeriesIndex: -1
        })
      },
      fail: function () {
      }
    })
  },
  bindCarSeries: function (e) {
    var that = this;
    wx.request({
      url: 'https://api.mangoauto.com.cn/Wx/GetPropInfo.ashx?property_id=2&prop_value_id=' + that.data.dataCarCode,
      header: {
        'Content-Type': 'application/json'
      },
      success: function (res) {
        var seric = res.data.data;
        that.setData({
          carSeriesInfo: seric,
          carTypesIndex: -1
        })
      },
      fail: function () {
      }
    })
  },
  bindCarTypes: function (e) {
    var that = this;
    wx.request({
      url: 'https://api.mangoauto.com.cn/Wx/GetPropInfo.ashx?property_id=3&prop_value_id=' + that.data.carSerieCode,
      header: {
        'Content-Type': 'application/json'
      },
      success: function (res) {
        var typeArray = res.data.data;
        that.setData({
          carTypesInfo: typeArray
        })
      },
      fail: function () {
      }
    });
  },
  bindCarHandle: function (e) {
    var that = this;
    var cartype = that.data.dataCarName;
    that.getbrandInfo(cartype)
  },
  bindCarInput: function (e) {
    var that = this;
    var cartype = e.detail.value;
    that.getbrandInfo(cartype)
  },
  mobileInput: function (e) {
    var that = this;
    var usermobile = e.detail.value;
    that.setData({
      userMobile: usermobile
    })
  },
  changeCarInput: function (e) {
    var that = this;
    that.setData({
      dataCarCode: e.currentTarget.dataset.carcode,
      dataCarName: e.currentTarget.dataset.carname,
      carBrandList: [],
    });
    that.bindCarSeries()
  },
  seriesPicker: function (e) {
    var that = this;
    var serieCode = that.data.carSeriesInfo[e.detail.value].prop_value_id
    that.setData({
      carSeriesIndex: e.detail.value,
      carSerieCode: serieCode
    })
    that.bindCarTypes()
  },
  typesPicker: function (e) {
    var that = this;
    var typeCode = that.data.carTypesInfo[e.detail.value].prop_value_id
    that.setData({
      carTypesIndex: e.detail.value,
      cartypeCode: typeCode
    })
  },
  slider4change: function (e) {
    //获取滑动后的值
    this.setData({
      priceVal: e.detail.value
    });
  },
  okSubmit: function (e){
    var that = this;
    if (that.data.dataCarCode == '' || that.data.carSerieCode == '' || that.data.cartypeCode == ''){
      return wx.showModal({
        title: '提示',
        content: '请选择您要提醒的车型',
        showCancel: false,
      });
    }
    if (that.data.userMobile == ''){
      return wx.showModal({
        title: '提示',
        content: '请输入您的联系方式',
        showCancel: false,
      });
    } 
    if (that.data.userMobile != '') {
      let check = new RegExp("^0?(13[0-9]|15[0-9]|18[0-9]|17[0-9]|14[0-9]|19[0-9]|16[0-9])[0-9]{8}$");
      if (!check.test(that.data.userMobile)){
        return wx.showModal({
          title: '提示',
          content: '请输入正确的联系方式',
          showCancel: false,
          success: function () {
            that.setData({
              userMobile: ''
            })
          }
        });
      }
    }
    var getUserInfo = getApp().globalData.users;
    var getData = [];
    var props = "1:" + that.data.dataCarCode + ";2:" + that.data.carSerieCode + ";3:" + that.data.cartypeCode;
    wx.request({
      url: 'https://api.mangoauto.com.cn/Wx/GetPriceInfo.ashx?props=' + props,
      header: {
        'Content-Type': 'application/json'
      },
      success: function (res) {
        getData.price = res.data.data[0].price;
        getData.product_price = res.data.data[0].product_price;
      }
    })
    getData.carCode = that.data.dataCarCode + ';' + that.data.carSerieCode + ';' + that.data.cartypeCode;
    getData.carType = that.data.dataCarName + ' ' + that.data.carSeriesInfo[that.data.carSeriesIndex].value_name + ' ' + that.data.carTypesInfo[that.data.carTypesIndex].value_name;
    getData.channel = 0;
    getData.encryptedData = getUserInfo.encryptedData;
    getData.guess_yn = 0;
    getData.is_guess = 0;
    getData.iv = getUserInfo.iv;
    getData.openid = getUserInfo.openId;
    getData.phone = that.data.userMobile;
    getData.price_val = that.data.priceVal;
    getData.session_key = getUserInfo.session_key;
    getData.sex = 0;
    getData.username = getUserInfo.nikeName;
    console.log(getData)
    wx.request({
      url: 'https://api.mangoauto.com.cn/Wx/SavePriceReminder.ashx',
      data: getData,
      header: {
        'Content-Type': 'application/json'
      },
      success: function (res) {
        that.resetCartype();
        wx.showToast({
          title: '提交成功',
          icon: 'success',
          duration: 2000
        });
      }
    })
  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {

  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {

  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {

  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {

  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function () {

  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {

  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {

  }
})