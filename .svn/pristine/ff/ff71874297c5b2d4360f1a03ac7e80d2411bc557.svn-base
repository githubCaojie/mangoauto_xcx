var config = require("../../utils/config.js");
var mta = require('../../utils/mta_analysis.js')
var app = getApp();

var islogin = true;
var distributorId;
Page({
  /**
   * 页面的初始数据
   */
  data: {
    outurl: "",
    originUrl: "",
    type: "",
    login_code: "",
    login_iv: "",
    encrypte: "",
    openid: "",
    unionid: "",
    showUrlBtn: false,
    showMsgtext: false,
    action:"",
    flag: ""
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    var that = this,
      web_src = decodeURIComponent(options.url),
      userInfo = wx.getStorageSync("userInfo"),
      wxusers = app.globalData.wxUserInfo,
      openid = wx.getStorageSync('outUrlOpenId');
    if (options.ShareTitle == '' || options.ShareImg == '' || options.type == ''){
      that.setData({
        shareTitle: options.ShareTitle,
        shareImg: options.ShareImg,
        type: options.type
      });
    } 
    that.setData({
      originUrl: web_src
    });
    wx.login({
      success(res) {
        that.setData({
          login_code: res.code
        })
      },
      fail(e) {
      }
    });
    //查找url参数值(action与flag)
    that.getQueryVariable();
    if (openid != "") {
      that.setData({
        showUrlBtn: true
      })
      wx.request({
        url: 'https://api.mangoauto.com.cn/Wx/Fs.ashx',
        data: {
          user_name: '',
          user_mobile: openid.phone,
          remark: '',
          action: 'dobmsss',
          type: that.data.action,
          remark1: 'WX',
          openid: openid.openid,
          actions: that.data.action,
          union_id: openid.unionid
        },
        dataType: 'json',
        cache: false,
        success: function (res) {
          that.addAccessStat(openid.openid, '660', '00', '')
          wx.navigateTo({
            url: 'geturl?url=' + that.data.originUrl,
          })
        }
      })
    } else {
      that.addAccessStat('', '660', '00', '')
    }
    // 判断用户在后台是否已经有手机号码
    if (userInfo != '') {
      wx.request({
        url: 'https://api.mangoauto.com.cn/Wx/Fs.ashx',
        data: {
          user_name: wxusers.Nick,
          user_mobile: userInfo.CellPhone,
          remark: '',
          action: 'dobmsss',
          type: that.data.action,
          remark1: 'WX',
          openid: wxusers.openId,
          actions: that.data.action,
          union_id: wxusers.unionId
        },
        dataType: 'json',
        cache: false,
        success: function (res) {
          wx.setStorageSync('outUrlOpenId', that.data.openid);
          wx.navigateTo({
            url: 'geturl?url=' + that.data.originUrl,
          })
        }
      })
    } else {

    }
  },
  // 数据统计
  addAccessStat: function (openid, pages, even, param) {
    wx.request({
      url: 'https://wx.mangoauto.com.cn/Pages/Ajax/AccessStatHandle.ashx?action=' + 'addAccess' + '&openid=' + openid + '&pages=' + pages + '&even=' + even + '&param=' + param,
      data: {},
      dataType: 'json',
      method: "GET",
      cache: false,
      headers: { formData: { action: 'addAccess' } },
      success(data) {
        if (data.state == "1") {
        } else {
        }
      }
    })
  },
  // 获得小程序的页面参数
  getQueryVariable: function () {
    var that = this,
      url = that.data.originUrl;
    url.indexOf('\u0026') != -1 ? url = url.replace(/\\u0026/g, '&') : url.indexOf('amp') != -1 ? url = url.replace(/amp/g, '&') : url;
    var querys = url.substring(url.indexOf('?') + 1).split('&').map((query) => query.split('=')).reduce((params, pairs) => (params[pairs[0]] = pairs[1] || '', params), {});
    mta.Event.stat('outurl', { 'flag': querys.flag })
    mta.Event.stat('outurl', { 'action': querys.action })
    for (var key in querys) {
      key == 'action' ? that.setData({ action: querys[key] }) : key == 'flag' ? that.setData({ flag: querys[key]}):'';
    }
    if (that.data.flag == 0 || that.data.flag =='') {
      that.addAccessStat('', '660', '00', '')
      return wx.navigateTo({
        url: 'geturl?url=' + url,
      })
    }
  },
  getlogon: function () {
    wx.showLoading({
      title: '加载中',
      mask: true,
    })
    var that = this;
    wx.checkSession({
      success(obj) {
        that.decodePhone()
      }, fail(err) {
        that.decodePhone()
      }
    })
  },
// 授权
  decodePhone: function (){
    var that = this;
    wx.login({
      success(res) {
        wx.request({
          url: app.getUrl('login/GetOpenId'),
          data: {
            appid: app.globalData.appId,
            secret: app.globalData.secret,
            js_code: res.code
          },
          success: function (result) {
            if (result.data.success) {
              that.setData({
                openid: result.data.data.openid,
                unionid: result.data.data.unionid
              })
              wx.request({
                url: app.getUrl("Login/GetWxMobile"),
                data: {
                  encrypteddata: that.data.encrypte,
                  session_key: result.data.data.session_key,
                  iv: that.data.login_iv,
                  unionid: that.data.unionid
                },
                success(res) {
                  if (res.data.data.success == false) {
                  } else {
                    that.setData({
                      phone: res.data.data.data.phoneNumber
                    })
                    if (res.statusCode == 200) {
                      wx.request({
                        url: 'https://api.mangoauto.com.cn/Wx/Fs.ashx',
                        data: {
                          user_name: '',
                          user_mobile: that.data.phone,
                          remark: '',
                          action: 'dobmsss',
                          type: that.data.action,
                          remark1: 'WX',
                          openid: that.data.openid,
                          actions: that.data.action,
                          union_id: result.data.data.unionid
                        },
                        dataType: 'json',
                        cache: false,
                        success: function (res) {
                          that.addAccessStat(that.data.openid, '660', '00', '')
                          var outUrlUserM = {
                            openid : that.data.openid,
                            phone: that.data.phone,
                            unionid: that.data.unionid
                          }
                          wx.setStorageSync('outUrlOpenId', outUrlUserM);
                          wx.navigateTo({
                            url: 'geturl?url=' + that.data.originUrl,
                          })
                        }
                      })
                    }
                  }
                }
              })
            }
          }
        })
      }
    })
  },
  // 点击获取手机号码
  getPhoneNumber: function (e) {
    var that = this;
    if (e.detail.errMsg == 'getPhoneNumber:fail user deny' || e.detail.errMsg == 'getPhoneNumber:fail:user deny') {
      wx.showToast({
        title: '授权手机号才能让销售更好的服务于您',
        icon: 'none',
        duration: 2000
      })
        }
    if (e.detail.errMsg == 'getPhoneNumber:ok') {
      that.setData({
        encrypte: e.detail.encryptedData,
        login_iv: e.detail.iv
      })
      that.getlogon()
    }
  },


  bindGetUserInfo: function (e) {
    var type = e.currentTarget.dataset.type;
    if (type == 'byuser') {
      this.loginbyUser();
    } else {
      islogin = true;
      this.quickLogin();
    }
  },
  onShow: function () {
  },
  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function (options) {
  }
})